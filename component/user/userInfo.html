<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="../../js/vue1.0.js" type="text/javascript" charset="utf-8"></script>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../public/public.css"/>
		<script src="../../js/jquery-2.1.0.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="../../js/zepto_1.1.3.js" type="text/javascript" charset="utf-8"></script>-->
		<script src="../../public/public.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/setrem.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.hidden{
				z-index: 22;
				position: absolute;
				left: 0;
				right: 0;
				bottom: 0.49rem;
				top: 0.44rem;
				background: rgba(0,0,0,0.4);
				display: none;
			}
			.center{
				
			}
			
			
			
			.portrait{
				height: 1.19rem;
				width: 100%;
				background: url(../../image/bg.png) repeat;
				
				display: flex;
				justify-content: center;
				align-items: center;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				-webkit-justify-content: center;
				-webkit-align-items: center;
				
				font-size: 0.16rem;
			}
			.portrait .setportrait{
				height: 0.87rem;
				width: 100%;
				display: flex;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				background: #fff;
			}
			.portrait #portrait{
				flex: 5;
				-webkit-flex: 5;
				text-align: left;
				padding-left: 0.15rem;
				line-height: 0.87rem;
				color: #61523a;
			}
			.portrait #userportrait{
				flex: 2;
				-webkit-flex: 2;
				display: flex;
				justify-content: center;
				align-items: center;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				-webkit-justify-content: center;
				-webkit-align-items: center;
			}
			.portrait #userportrait img{
				height: 0.65rem;
				width: 0.65rem;
				display: inline-block;
				border-radius: 0.1rem;
			}
			.portrait a{
				line-height: 0.87rem;
				text-align: center;
				flex: 1;
				-webkit-flex: 1;
				color: #ababab;
			}
			.seticon{
				color: #ABABAB;
			}
			.infoContent{
				height: 3.05rem;
				width: 100%;
				
			}
			.infoContent li{
				display: flex;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				height: 0.42rem;
				width: 100%;
				border-bottom: 1px solid #d9d9d9 ;
				line-height: 0.42rem;
			}
			.infoContent li .setkey{
				flex: 4;
				-webkit-flex: 4;
				padding-left:0.15rem ;
				color: #615138;
				font-size: 0.16rem;
			}
			.infoContent li .consd{
				flex: 12;
				-webkit-flex: 12;
				color: #D9D9D9;
				font-size: 0.13rem;
				line-height: 0.42rem;
			}
			.infoContent li a{
				line-height: 0.42rem;
				text-align: center;
				flex: 2;
				-webkit-flex: 2;
			}
			.infoContent li .muisd{
				flex: 4;
				-webkit-flex: 4;
			}
			.infoContent li .tagmusic{
				flex: 4;
				-webkit-flex: 4;
				display: flex;
				justify-content: center;
				align-items: center;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				-webkit-justify-content: center;
				-webkit-align-items: center;
			}
			.infoContent li input{
				margin: 0;
				padding: 0;
				border: none;
				height: 0.38rem;
				line-height: 0.38rem;
				width: 100%;
				font-size: 0.12rem;
				color: #000;
				background: #EFEFF4;
			}
			.tagmusic .tag{
				display: inline-block;
				height: 0.26rem;
				width: 0.52rem;
				background: url(../../image/RoundedRectangle8copy4@2x.png) no-repeat;
				background-size:cover ;
				left: 0;
				top: 0.08rem;
				position: relative;
			}
			.tagmusic .tag .taginoc{
				
			}
			.infoContent .setpassword{
				
			}
			footer{
				height: 0.81rem;
				background: url(../../image/bg.png) repeat;
				width: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
				display: -webkit-box;     
				display: -moz-box;        
				display: -ms-flexbox;      
				display: -webkit-flex;
				-webkit-justify-content: center;
				-webkit-align-items: center;
			}
			footer .out{
				background: #fe9900;
				height: 0.47rem;
				width: 2.9rem;
				border-radius: 0.02rem;
				font-size: 0.18rem;
				text-align: center;
				line-height: 0.47rem;
				color: #fff;
			}
			#subinfo{
				font-size: 0.12rem;
				display: block;
				line-height: 0.44rem;
				height: 0.44rem;
				float: right;
			}
			
		</style>
	</head>
	<body>
		<div id="vuedom" class="center">
		<div class="hidden">
			
		</div>
		<header class="mui-bar ">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">用户资料</h1>
			<a @click="setuserinfo" id="subinfo" class="">完成</a>
		</header>
		<div class="portrait">
			<div class="setportrait">
				<div id="portrait">
					头像
				</div>
				<div id="userportrait">
					<img id="mainImage" :src="userheadimg">
				</div>
				
				<a id="headImage" class=" mui-icon mui-icon-arrowright seticon"></a>
			</div>
		</div>
		<div class="infoContent">
			<ul>
				<li>
					<div class="setkey">修改密码</div>
					<div class="consd"></div>
					<a href="setpassword.html" class=" mui-icon mui-icon-arrowright seticon"></a>
				</li>
				<li>
					<div class="setkey">手机号</div>
					<div class="consd">
						
						<input v-if="userinfo.Tel==''" type="" name="" id=""  v-model="setuserinfoobj.Tel"  placeholder="添加手机号，仅填一次，不可修改"/>
						<span v-if="userinfo.Tel!=''">{{userinfo.Tel}}</span>
					</div>
					
				</li>
				
				<li>
					<div class="setkey">微信号</div>
					<div class="consd">
						<input v-if="userinfo.WeChat==''" type="" name="" id=""  v-model="setuserinfoobj.WeChat"   placeholder="添加微信号，仅填一次，不可修改"/>
						<span v-if="userinfo.WeChat!=''">{{userinfo.WeChat}}</span>
					</div>
					
				</li>
				<li>
					<div class="setkey">支付宝</div>
					<div class="consd">
						<input v-if="userinfo.alipay==''" type="" name="" id="" v-model="setuserinfoobj.alipay"   placeholder="添加支付宝，仅填一次，不可修改"/>
						<span v-if="userinfo.alipay!=''">{{userinfo.alipay}}</span>
					</div>
					
				</li>
				<li>
					<div class="setkey">银行卡</div>
					<div class="consd">
						<input v-if="userinfo.bankcard==''" type="" name="" id="" v-model="setuserinfoobj.bankcard"   placeholder="添加银行卡，仅填一次，不可修改"/>
						<span v-if="userinfo.bankcard!=''">{{userinfo.bankcard}}</span>
					</div>
					
				</li>
				<li>
					<div class="setkey">QQ号</div>
					<div class="consd">
						<input v-if="userinfo.qq==''" type="" name="" id="" v-model="setuserinfoobj.qq"  placeholder="添加QQ号，仅填一次，不可修改"/>
						<span v-if="userinfo.qq!=''">{{userinfo.qq}}</span>
					</div>
				
				</li>
				<li>
					<div class="setkey">音乐开关</div>
					<div class="muisd">
						
					</div>
					<div class="tagmusic">
						<div class="switch">
							<div id="mySwitch" class=" mui-switch">
							  <div class="mui-switch-handle"></div>
							</div>
						</div>
						<!--<span class="tagtext">On</span>
						<span class="tag">
							<span class="taginoc">
								
							</span>
						</span>-->
					</div>
					<!--<a class=" mui-icon mui-icon-arrowright seticon"></a>-->
				</li>
			</ul>
		</div>
		<footer>
			<div @click="out" class="out">
				退出登录
			</div>
			
		</footer>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init()
			mui.plusReady(function(){
			var f1=null;	
			function getImage() { 
		            var c = plus.camera.getCamera(); 
		            c.captureImage(function(e) { 
		                plus.io.resolveLocalFileSystemURL(e, function(entry) { 
		                    var s = entry.toLocalURL() + "?version=" + new Date().getTime(); 
		                    appendFile(s); /*上传图片*/ 
		                }, function(e) { 
		                    console.log("读取拍照文件错误：" + e.message); 
		                }); 
		            }, function(s) { 
		                console.log("error" + s); 
		            }, { 
		                filename: "_doc/head.png" 
		            }) 
		        } 
		   	function appendFile(path){//压缩图片
				
				  var img = new Image();
				        img.src = path;        // 传过来的图片路径在这里用。
				        img.onload = function () {
				            var that = this;
				            //生成比例 
				            var w = that.width,
				                h = that.height,
				                scale = w / h; 
				                w = 480 || w;              //480  你想压缩到多大，改这里
				                h = w / scale;
				
				            //生成canvas
				            var canvas = document.createElement('canvas');
				
				            var ctx = canvas.getContext('2d');
				
				            $(canvas).attr({width : w, height : h});
				
				            ctx.drawImage(that, 0, 0, w, h);
				
				            var base64 = canvas.toDataURL('image/jpeg', 1 || 0.8 );   //1最清晰，越低越模糊。有一点不清楚这里明明设置的是jpeg。弹出 base64 开头的一段 data：image/png;却是png。哎开心就好，开心就好
				//              alert(base64);      
				
				           f1 =base64;   // 把base64数据丢过去，上传要用。
				
				            var pic = document.getElementById("mainImage");   
				           // console.log(JSON.stringify(pic))
				          //  pic.src = base64; 
				            uploadss()//这里丢到img 的 src 里面就能看到效果了
				    }
				
				}
		        
		    function uploadss(){ //上传图片
			
			     var wt=plus.nativeUI.showWaiting();
			     var url = 'http://bjsc.bayuenet.com/index.php/admin/index/upload';
			            var dataType ='json';
			            //发送数据  
			            var data = { 
			                Uploads:f1       //base64数据        
			            };    
			            $.post(url, data, success, dataType);                          
			}
			        //成功响应的回调函数
			        var success = function(data) {   
			        	console.log(JSON.stringify(data))
			            plus.nativeUI.closeWaiting();
			            if(data.code==200){
			            	localStorage.setItem('headimg',data.imPath)
			                dialoginfo("上传成功"); 
			            }else{
			            	 dialoginfo("上传失败");
			            }
			
			     }     
		        
		        
			//本地相册选择 
        function galleryImg() { 
            plus.gallery.pick(function(a) { 
                plus.io.resolveLocalFileSystemURL(a, function(entry) { 
                    plus.io.resolveLocalFileSystemURL("_doc/", function(root) { 
                        root.getFile("head.png", {}, function(file) { 
                            //文件已存在 
                            file.remove(function() { 
                                console.log("file remove success"); 
                                entry.copyTo(root, 'head.png', function(e) { 
                                        var e = e.fullPath + "?version=" + new Date().getTime(); 
                                        appendFile(e); /*上传图片*/ 
                                        //变更大图预览的src 
                                        //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现 1
                                    }, 
                                    function(e) { 
                                        console.log('copy image fail:' + e.message); 
                                    }); 
                            }, function() { 
                                console.log("delete image fail:" + e.message); 
                            }); 
                        }, function() { 
                            //文件不存在 
                            entry.copyTo(root, 'head.png', function(e) { 
                                    var path = e.fullPath + "?version=" + new Date().getTime(); 
                                    appendFile(path); /*上传图片*/ 
                                }, 
                                function(e) { 
                                    console.log('copy image fail:' + e.message); 
                                }); 
                        }); 
                    }, function(e) { 
                        console.log("get _www folder fail"); 
                    }) 
                }, function(e) { 
                    console.log("读取拍照文件错误：" + e.message); 
                }); 
            }, function(a) {}, { 
                filter: "image" 
            }) 
        };
 		document.getElementById('headImage').addEventListener('tap', function() { 
 			
	            if (mui.os.plus) { 
	                var a = [{ 
	                    title: "拍照" 
	                }, { 
	                    title: "从手机相册选择" 
	                }]; 
	                plus.nativeUI.actionSheet({ 
	                    title: "修改用户头像", 
	                    cancel: "取消", 
	                    buttons: a 
	                }, function(b) { /*actionSheet 按钮点击事件*/ 
	                    switch (b.index) { 
	                        case 0: 
	                            break; 
	                        case 1: 
	                            getImage(); /*拍照*/ 
	                            break; 
	                        case 2: 
	                            galleryImg();/*打开相册*/ 
	                            break; 
	                        default: 
	                            break; 
	                    } 
	                }) 
	            } 
	        }, false); 
	        
	    document.getElementById("mySwitch").addEventListener("toggle",function(event){
			  if(event.detail.isActive){
			  	localStorage.setItem('Musicswitch',1)
			    console.log("你启动了开关");
			  }else{
			  	localStorage.setItem('Musicswitch',0)
			    console.log("你关闭了开关");  
			  }
			})    
	    
			var vuedom=new Vue({
				el:'#vuedom',
				data:{
					userid:'',
					userinfo:{},
					userheadimg:'../../image/weishangchuantouxiang@2x.png',
					setuserinfoobj:{
						qq:'',
						WeChat:'',
						alipay:'',
						bankcard:'',
						Tel:''
					}
					
				},
				methods:{
					getuserinfo:function(){
						var vm=this
						console.log(vm.userid)
						mui.post('http://bjsc.bayuenet.com/index.php/admin/index/SelectUserInfo',{
								id:vm.userid,
							},function(data){
								vm.userinfo=data.userinfo
								vm.setextend()
							
							},'json'
						);
						mui.post('http://bjsc.bayuenet.com/index.php/admin/index/facepath',{//获取 头像
								id:vm.userid,
							},function(data){
								console.log(JSON.stringify(data))
								if(data.code==200&&CheckImgExists(data.face)){
									
									vm.userheadimg=data.face
								}
								
								},'json'
							);
					},
					setextend:function(){
						var vm=this
						var userinfo=this.userinfo
					//	console.log(JSON.stringify(userinfo))
						for ( i in userinfo){
							if(userinfo[i]!=''&&userinfo[i]!=null){
							
								vm.setuserinfoobj[i]=userinfo[i]
							}
						}
						//console.log(JSON.stringify(vm.setuserinfoobj))
					},
					setuserinfo:function(){
					//	console.log(JSON.stringify(this.setuserinfoobj))
//						if(!isMobile(this.setuserinfoobj.Tel)){
//							dialoginfo('请输入正确的手机号')
//							return
//						}
//						if(!isQQ(this.setuserinfoobj.qq)){
//							dialoginfo('请输入正确的qq号')
//							return
//						}
//						if(!isbankcard(this.setuserinfoobj.bankcard)){
//							dialoginfo('请输入正确的银行号码')
//							return
//						}
						
						var userinfo=this.setuserinfoobj
						userinfo.id=this.userid
						console.log(JSON.stringify(userinfo))
						var vm=this
						mui.post('http://bjsc.bayuenet.com/index.php/admin/index/UpdateInfo',userinfo,function(data){
								//vm.userinfo=data.userinfo
								vm.getuserinfo()
								//console.log(JSON.stringify(data))
							},'json'
						);
						
					},
					out:function(){
						
						var backButtonPress = 0;
						var isout=mui.confirm('确认退出皇家会所？',function(s){
							if(s.index){
								localStorage.removeItem('username')
								localStorage.removeItem('userid')
								plus.runtime.quit();
								return
							}else{
								return
							}
						})
					
						
							
	
					}
				},
				ready:function(){
					this.userid=localStorage.getItem('userid')
				
					this.getuserinfo()
					if(localStorage.getItem('Musicswitch')==1){
						
						$('#mySwitch').addClass('mui-active')
					}else{
						$('#mySwitch').removeClass('mui-active')
					}
					
					
					
				}
			})
			
			
			
				
			})
			
		</script>
	</body>

</html>